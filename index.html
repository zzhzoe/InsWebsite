<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户调查与图片浏览</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .post { border: 1px solid #ddd; margin-bottom: 20px; padding: 10px; }
        .post img { max-width: 100%; }
        .like-btn { background-color: #3897f0; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="app">
        <div id="user-form" style="display: block;">
            <h2>请填写您的信息</h2>
            <form id="survey-form">
                <label for="name">姓名：</label>
                <input type="text" id="name" required><br><br>
                <label for="age">年龄：</label>
                <input type="number" id="age" required><br><br>
                <label for="gender">性别：</label>
                <select id="gender" required>
                    <option value="">请选择</option>
                    <option value="male">男</option>
                    <option value="female">女</option>
                    <option value="other">其他</option>
                </select><br><br>
                <button type="submit">提交</button>
            </form>
        </div>

        <div id="posts" style="display: none;">
            <!-- 这里将通过JavaScript动态添加帖子 -->
        </div>
    </div>

    <script>
    // Firebase 配置
    const firebaseConfig = {
        apiKey: "AIzaSyC13M47F_4HcP5Z0KPvnPdRs7FCzfwoKus",
        authDomain: "research-project-0801.firebaseapp.com",
        projectId: "research-project-0801",
        storageBucket: "research-project-0801.appspot.com",
        messagingSenderId: "655922410105",
        appId: "1:655922410105:web:b0919370054af912261aa8",
        measurementId: "G-PX7PE1V6S3"
    };

    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let userData = {};
    let currentPost = 0;
    const totalPosts = 10;
    let startTime;

    document.getElementById('survey-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log("表单提交被触发");
        
        userData = {
            name: document.getElementById('name').value,
            age: parseInt(document.getElementById('age').value),
            gender: document.getElementById('gender').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            posts: []
        };
        
        console.log("用户数据:", userData);

        try {
            const docRef = await db.collection('users').add(userData);
            console.log("Document written with ID: ", docRef.id);
            alert('用户信息已成功提交！');
            document.getElementById('user-form').style.display = 'none';
            document.getElementById('posts').style.display = 'block';
            showNextPost();
        } catch (error) {
            console.error("Error adding document: ", error);
            alert('提交数据时出错，请重试。');
        }
    });

    function showNextPost() {
        if (currentPost < totalPosts) {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            postElement.innerHTML = `
                <h3>Post ${currentPost + 1}</h3>
                <img src="https://via.placeholder.com/400" alt="Post ${currentPost + 1}">
                <button class="like-btn" onclick="likePost(${currentPost})">赞</button>
            `;
            document.getElementById('posts').innerHTML = '';
            document.getElementById('posts').appendChild(postElement);
            startTime = Date.now();
            currentPost++;
        } else {
            finishSurvey();
        }
    }

    async function likePost(postId) {
        const viewTime = (Date.now() - startTime) / 1000;
        userData.posts.push({
            id: postId,
            liked: true,
            viewTime: viewTime
        });
        try {
            await db.collection('users').doc(userData.docId).update({
                posts: firebase.firestore.FieldValue.arrayUnion({
                    id: postId,
                    liked: true,
                    viewTime: viewTime
                })
            });
            console.log("Post data updated successfully");
        } catch (error) {
            console.error("Error updating post data: ", error);
        }
        showNextPost();
    }

    async function finishSurvey() {
        document.getElementById('posts').innerHTML = '<h2>感谢您完成调查！</h2>';
        console.log("Survey completed. Final user data:", userData);
        try {
            await db.collection('users').doc(userData.docId).update({
                surveyCompleted: true
            });
            console.log("Survey marked as completed in Firestore");
        } catch (error) {
            console.error("Error marking survey as completed: ", error);
        }
    }
    </script>
</body>
</html>
