<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Survey and Image Browsing</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .post { border: 1px solid #ddd; margin-bottom: 20px; padding: 10px; }
        .post img { max-width: 100%; }
        .like-btn { background-color: #3897f0; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="app">
        <div id="user-form" style="display: block;">
            <h2>Please Fill in Your Information</h2>
            <form id="survey-form">
                <label for="name">Name:</label>
                <input type="text" id="name" required><br><br>
                <label for="age">Age:</label>
                <input type="number" id="age" required><br><br>
                <label for="gender">Gender:</label>
                <select id="gender" required>
                    <option value="">Please select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select><br><br>
                <button type="submit">Submit</button>
            </form>
        </div>

        <div id="posts" style="display: none;">
            <!-- Posts will be dynamically added here by JavaScript -->
        </div>
    </div>

    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC13M47F_4HcP5Z0KPvnPdRs7FCzfwoKus",
        authDomain: "research-project-0801.firebaseapp.com",
        projectId: "research-project-0801",
        storageBucket: "research-project-0801.appspot.com",
        messagingSenderId: "655922410105",
        appId: "1:655922410105:web:b0919370054af912261aa8",
        measurementId: "G-PX7PE1V6S3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let userData = {};
    let currentPost = 0;
    const totalPosts = 10;
    let startTime;

    document.getElementById('survey-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log("Form submission triggered");
        
        userData = {
            name: document.getElementById('name').value,
            age: parseInt(document.getElementById('age').value),
            gender: document.getElementById('gender').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            posts: []
        };
        
        console.log("User data:", userData);

        try {
            const docRef = await db.collection('users').add(userData);
        console.log("Document written with ID: ", docRef.id);
        userData.docId = docRef.id;
        alert('User information submitted successfully!');
        document.getElementById('user-form').style.display = 'none';
        document.getElementById('posts').style.display = 'block';
        console.log("Switched to posts view");
        showNextPost();
    } catch (error) {
        console.error("Error submitting data:", error);
        alert('Error submitting data. Please try again.');
    }
});

    function showNextPost() {
    console.log("showNextPost called, current post:", currentPost);
    if (currentPost < totalPosts) {
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.innerHTML = `
            <h3>Post ${currentPost + 1}</h3>
            <img src="https://via.placeholder.com/400" alt="Post ${currentPost + 1}">
            <button class="like-btn" onclick="likePost(${currentPost})">Like</button>
        `;
        document.getElementById('posts').innerHTML = '';
        document.getElementById('posts').appendChild(postElement);
        console.log("Post added to DOM");
        startTime = Date.now();
        currentPost++;
    } else {
        console.log("All posts have been displayed");
        finishSurvey();
    }
}

    async function likePost(postId) {
    const viewTime = (Date.now() - startTime) / 1000;
    console.log(`Liking post ${postId}, view time: ${viewTime} seconds`);
    
    try {
        await db.collection('users').doc(userData.docId).update({
            posts: firebase.firestore.FieldValue.arrayUnion({
                id: postId,
                liked: true,
                viewTime: viewTime
            })
        });
        console.log("Post data updated successfully");
    } catch (error) {
        console.error("Error updating post data: ", error);
    }
    showNextPost();
}

    async function finishSurvey() {
    document.getElementById('posts').innerHTML = '<h2>Thank you for completing the survey!</h2>';
    console.log("Survey completed. Final user data:", userData);
    try {
        await db.collection('users').doc(userData.docId).update({
            surveyCompleted: true
        });
        console.log("Survey marked as completed in Firestore");
    } catch (error) {
        console.error("Error marking survey as completed: ", error);
    }
}
    </script>
</body>
</html>
