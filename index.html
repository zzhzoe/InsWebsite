  <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <div id="user-form">
           <img src="https://zzhzoe.github.io/InsWebsite/post_images/IMG_0619.PNG" alt="Instagram" class="instagram-logo">
            <form id="survey-form">
    </div>

    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC13M47F_4HcP5Z0KPvnPdRs7FCzfwoKus",
        authDomain: "research-project-0801.firebaseapp.com",
        projectId: "research-project-0801",
        storageBucket: "research-project-0801.appspot.com",
        messagingSenderId: "655922410105",
        appId: "1:655922410105:web:b0919370054af912261aa8",
        measurementId: "G-PX7PE1V6S3"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // Global variables
    let currentPage = 'user-form';
    let userData = {};
    let postViewTimes = {};
    let startTime;
    let postDataCache = {};
    const timeLimit = 3 * 60 * 1000; // 3 minutes in milliseconds
    const VISIBILITY_THRESHOLD = 50; // Percentage of post that needs to be visible
    const UPDATE_INTERVAL = 200; // Update interval in milliseconds
    let postViewStates = {};
    let timerInterval;
    let isSurveyCompleted = false;
    const baseUrl = "https://zzhzoe.github.io/InsWebsite/post_images/";
   const fixedPosts = [
    {
        username: "cats_golden",
        profilePic: baseUrl + "post/2.jpg",
        isAI: true
    }
];
// Function to show different pages
function showPage(pageId) {
    document.getElementById('user-form').style.display = 'none';
    document.getElementById('posts').style.display = 'none';
    document.getElementById('thank-you').style.display = 'none';
    }
}

// Function to generate posts
function generatePosts() {
    const posts = fixedPosts.map(post => ({...post, id: post.username}));
    const randomVariablePost = variablePosts[Math.floor(Math.random() * variablePosts.length)];
    posts.unshift(randomVariablePost);
    return shuffleArray(posts);
}

// Function to shuffle array
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
    return array;
}

// Function to create post element
function createPostElement(post) {
    const postElement = document.createElement('div');
    postElement.className = 'post';
            </div>
        </div>
        <div class="post-actions">
            <button class="like-button"><img src="https://img.icons8.com/ios/50/000000/hearts--v1.png" alt="Like"></button>
            <button><img src="https://img.icons8.com/ios/50/000000/comments--v1.png" alt="Comment"></button>
            <button><img src="https://img.icons8.com/ios/50/000000/sent--v1.png" alt="Share"></button>
        </div>
        <div class="post-likes">0 likes</div>
        <div class="post-caption"><strong>${post.username}</strong> ${formattedCaption}</div>
    `;

   const postImageContainer = postElement.querySelector('.post-image-container');
    let lastTap = 0;

    postImageContainer.addEventListener('click', function(e) {
    return postElement;
}

// Function to handle post liking
function likePost(postId) {
    if (isSurveyCompleted) return;
    const post = document.querySelector(`.post[data-post-id="${postId}"]`);
    const likeButton = post.querySelector('.like-button img');
    const likesElement = post.querySelector('.post-likes');
    let likes = parseInt(likesElement.textContent);


    likesElement.textContent = `${likes} likes`;

    updatePostData(postId, likes, getPostViewTime(postId));
}

// Function to show like overlay
function showLikeOverlay(container) {
    const overlay = container.querySelector('.like-overlay');
    overlay.style.display = 'flex';
    }, 1500);
}

// Function to load posts
function loadPosts() {
    const postsContainer = document.getElementById('posts');
    postsContainer.innerHTML = '';
    timerInterval = setInterval(checkTimeAndSubmit, 1000);
}

// Function to check time and submit survey
function checkTimeAndSubmit() {
    if (isSurveyCompleted) return;

    const currentTime = Date.now();
    const elapsedTime = currentTime - startTime;
    console.log(`Elapsed time: ${elapsedTime / 1000} seconds`);
        submitSurvey();
    }
}
// Function to get fixed UI dimensions
function getFixedUIDimensions() {
    const header = document.querySelector('header');
    const footer = document.querySelector('.footer');
    return {
        headerHeight: header ? header.offsetHeight : 0,
        footerHeight: footer ? footer.offsetHeight : 0
    };
}
// Function to get actual viewport
function getActualViewport() {
    const { headerHeight, footerHeight } = getFixedUIDimensions();
    const windowHeight = window.innerHeight || document.documentElement.clientHeight;
    const windowWidth = window.innerWidth || document.documentElement.clientWidth;
    return {
        top: headerHeight,
        bottom: windowHeight - footerHeight,
        left: 0,
        right: windowWidth,
        height: windowHeight - headerHeight - footerHeight,
        width: windowWidth
    };
}
// Function to calculate post visibility
function getPostVisibility(post) {
    const rect = post.getBoundingClientRect();
    const viewport = getActualViewport();
    const visibleTop = Math.max(viewport.top, rect.top);
    const visibleBottom = Math.min(viewport.bottom, rect.bottom);
    const visibleLeft = Math.max(viewport.left, rect.left);
    const visibleRight = Math.min(viewport.right, rect.right);
    const visibleWidth = Math.max(0, visibleRight - visibleLeft);
    const visibleHeight = Math.max(0, visibleBottom - visibleTop);
    const totalArea = rect.width * rect.height;
    const visibleArea = visibleWidth * visibleHeight;
    const visibilityPercentage = (visibleArea / totalArea) * 100;
    return {
        isVisible: visibilityPercentage >= VISIBILITY_THRESHOLD,
        visibilityPercentage: visibilityPercentage
    };
}
function updateViewTimes() {
    if (isSurveyCompleted) return;
    const posts = document.querySelectorAll('.post');
    const currentTime = Date.now();

                state.totalViewTime += viewDuration * (visibility.visibilityPercentage / 100);
                state.lastUpdateTime = currentTime;

                // Increment view count if it hasn't been incremented yet
                if (state.viewCount === 0) {
                    state.viewCount = 1;
                }
    });
}

// Function to update post data
function updatePostData(postId, likes, viewTime) {
    if (isSurveyCompleted) return;

    console.log(`Updating post data for post ${postId}: likes=${likes}, viewTime=${viewTime.toFixed(2)}`);

    if (!postDataCache[postId]) {
    }
}

// Function to send post data update to Firebase
function sendPostDataUpdate(postId) {
    if (isSurveyCompleted) return;
    const postData = postDataCache[postId];
    if (!postData) return;

            const existingPostIndex = currentPosts.findIndex(post => post.id === postData.id);

            let updatedPosts;
            const currentTime = new Date().toISOString();

            if (existingPostIndex !== -1) {
                updatedPosts = [...currentPosts];
                updatedPosts[existingPostIndex] = {
                    ...updatedPosts[existingPostIndex],
                    likes: postData.likes,
                    totalViewTime: postData.totalViewTime,
                    viewCount: postData.viewCount,
                    lastUpdateTime: currentTime
                };
            } else {
                updatedPosts = [
                    ...currentPosts,
                    {
            return Promise.reject("User document does not exist");
        }
    }).then(() => {
        postData.lastUpdateTime = Date.now();
        console.log("Post data successfully updated");
    }).catch((error) => {
        console.error("Error updating post data:", error);
    });
}

// Function to handle scroll events
function handleScroll() {
    if (!isSurveyCompleted) {
        updateViewTimes();
    }
}

// Function to handle beforeunload events
function beforeUnloadHandler() {
    if (!isSurveyCompleted) {
        Object.keys(postDataCache).forEach(sendPostDataUpdate);
    }
}

// Throttle function for performance optimization
function throttle(func, limit) {
    let inThrottle;
    return function() {
    }
}

// Set up event listeners
window.addEventListener('scroll', throttle(handleScroll, 100));
window.addEventListener('beforeunload', beforeUnloadHandler);
// Function to submit survey
async function submitSurvey() {
    if (isSurveyCompleted) return;
    console.log('Submitting survey...');
    clearInterval(timerInterval);
    updateViewTimes();

    Object.keys(postViewStates).forEach(postId => {
        const state = postViewStates[postId];
        if (state.totalViewTime > 0) {
            const post = document.querySelector(`.post[data-post-id="${postId}"]`);
            if (post) {
                const likes = parseInt(post.querySelector('.post-likes').textContent);
                updatePostData(postId, likes, state.totalViewTime);
            }
        }
    });
            totalTime: (Date.now() - startTime) / 1000
        });
        console.log('Survey submitted successfully');
        isSurveyCompleted = true;
        cleanupAfterSurvey();
        showPage('thank-you');
    } catch (error) {
        console.error("Error submitting survey:", error);
        alert('Error submitting data. Your responses may not have been saved.');
    }
}

// Function to clean up after survey completion
function cleanupAfterSurvey() {
    window.removeEventListener('scroll', handleScroll);
    window.removeEventListener('beforeunload', beforeUnloadHandler);
    clearInterval(timerInterval);
    postViewTimes = {};
    postViewStates = {};
    postDataCache = {};
    const postsContainer = document.getElementById('posts');
    postsContainer.innerHTML = '';
    console.log('Cleanup completed after survey submission');
}
// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    showPage('user-form');
            userData.docId = docRef.id;
            showPage('posts');
            loadPosts();
        } catch (error) {
            console.error("Error submitting data:", error);
            alert('Error logging in. Please try again.');
// Console log for debugging
console.log('JavaScript loaded and running');

   
    </script>
</body>
</html>
